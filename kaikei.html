<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>学生団体 会計ソフト（完全版・見やすいExcel版）</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body { font-family:sans-serif; margin:20px; background:#f9f9f9; }
h1,h2,h3 { color:#333; }
label { display:inline-block; margin:5px 10px 5px 0; }
input, select, button { padding:5px; margin:2px; }
table { border-collapse: collapse; width:100%; margin-top:10px; background:#fff; }
th, td { border:1px solid #ccc; padding:6px; text-align:center; }
th { background:#eee; font-weight:bold; }
button { cursor:pointer; }
#carryArea { background:#fff3cd; padding:10px; margin-bottom:10px; border:1px solid #ffeeba; }
#filters { margin-bottom:10px; }
</style>
</head>
<body>

<h2>表示フィルタ</h2>
<div id="filters">
<label>年度：
<select id="yearFilter"><option value="">すべて</option></select>
</label>

<label>月：
<select id="monthFilter">
<option value="">すべて</option>
<option value="1">1月</option><option value="2">2月</option><option value="3">3月</option><option value="4">4月</option>
<option value="5">5月</option><option value="6">6月</option>
<option value="7">7月</option><option value="8">8月</option>
<option value="9">9月</option><option value="10">10月</option>
<option value="11">11月</option><option value="12">12月</option>
</select>
</label>

<label>科目：
<select id="subjectFilter"><option value="">すべて</option></select>
</label>

<button onclick="render()">再表示</button>
</div>

<h1>会計入力</h1>

<div id="carryArea">
<h3>繰越金（初回のみ入力）</h3>
<label>現金 <input type="number" id="startCash" value="0"></label>
<label>通帳 <input type="number" id="startBank" value="0"></label>
<button onclick="setStart()">設定</button>
</div>

<hr>

<!-- 入力フォーム -->
<div id="entry">
<label>日付 <input type="date" id="date"></label>
<label>科目 
<select id="subject"></select>
</label>
<label>口座
<select id="account">
<option value="現金">現金</option>
<option value="通帳">通帳</option>
</select>
</label>
<label>内容 <input type="text" id="content"></label>
<label>区分
<select id="type">
<option value="収入">収入</option>
<option value="支出">支出</option>
<option value="振替">振替</option>
</select>
</label>
<label>金額 <input type="number" id="amount"></label>
<label>備考 <input type="text" id="note"></label>
<button onclick="save()">保存</button>
<button onclick="addSubject()">科目追加</button>
</div>

<h2>残高</h2>
現金：<span id="cashBal">0</span> ／ 通帳：<span id="bankBal">0</span>

<h2>出納帳</h2>
<table>
<thead>
<tr>
<th>日付</th><th>科目</th><th>内容</th>
<th>現金収入</th><th>現金支出</th><th>現金残高</th>
<th>通帳収入</th><th>通帳支出</th><th>通帳残高</th>
<th>備考</th><th>操作</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>

<br>
<button onclick="exportExcel()">Excel出力</button>

<script>
loadData();
let data = JSON.parse(localStorage.getItem("kaikei"))||[];
let subjects = JSON.parse(localStorage.getItem("subjects"))||[];
let startCash = Number(localStorage.getItem("startCash")||0);
let startBank = Number(localStorage.getItem("startBank")||0);

function setStart(){
  startCash = Number(document.getElementById("startCash").value);
  startBank = Number(document.getElementById("startBank").value);
  localStorage.setItem("startCash", startCash);
  localStorage.setItem("startBank", startBank);
  document.getElementById("carryArea").style.display="none";
  render();
}

function save(){
  const sub = document.getElementById("subject").value;
  if(sub && !subjects.includes(sub)){ subjects.push(sub); localStorage.setItem("subjects", JSON.stringify(subjects)); updateSubjectSelect(); }
  
  data.push({
    date:document.getElementById("date").value,
    type:document.getElementById("type").value,
    subject:sub,
    content:document.getElementById("content").value,
    amount:Number(document.getElementById("amount").value),
    account:document.getElementById("account").value,
    note:document.getElementById("note").value
  });
  data.sort((a,b)=>a.date.localeCompare(b.date));
  const jsonData = JSON.stringify(data);
  localStorage.setItem("kaikei", jsonData);
  saveData();
  updateFilters();
  render();
}

function del(i){
  if(confirm("削除しますか？")){
    data.splice(i,1);
    const jsonData = JSON.stringify(data);
    localStorage.setItem("kaikei", jsonData);
    saveData();
    updateFilters();
    render();
  }
}

async function saveData() {
  const data = {
    kaikei: localStorage.getItem("kaikei"),
    subjects: localStorage.getItem("subjects"),
    startCash: localStorage.getItem("startCash"),
    startBank: localStorage.getItem("startBank"),
  }
  await fetch("https://kaikei.osu-gakkenpo.workers.dev/?pw=" + localStorage.getItem("password"), {
    method: "POST",
    body: JSON.stringify(data),
  });
}

async function loadData() {
  const jsonData = await fetch("https://kaikei.osu-gakkenpo.workers.dev/?pw=" + localStorage.getItem("password"), {
    method: "GET",
  });

  const data = JSON.parse(jsonData);

  localStorage.setItem("kaikei", data.kaikei);
  localStorage.setItem("subjects", data.subjects);
  localStorage.setItem("startCash", data.startCash);
  localStorage.setItem("startBank", data.startBank);
}

function edit(i){
  const d=data[i];
  document.getElementById("date").value=d.date;
  document.getElementById("type").value=d.type;
  document.getElementById("subject").value=d.subject;
  document.getElementById("content").value=d.content;
  document.getElementById("amount").value=d.amount;
  document.getElementById("account").value=d.account;
  document.getElementById("note").value=d.note;
  del(i);
}

function addSubject(){
  const newSub = prompt("新しい科目名を入力してください");
  if(newSub && !subjects.includes(newSub)){
    subjects.push(newSub);
    localStorage.setItem("subjects", JSON.stringify(subjects));
    updateSubjectSelect();
    alert("科目追加しました");
  }
}

function updateSubjectSelect(){
  const subSelect = document.getElementById("subject");
  subSelect.innerHTML="";
  subjects.forEach(s=>{
    const opt = document.createElement("option");
    opt.value=s; opt.textContent=s;
    subSelect.appendChild(opt);
  });
  const subFilter = document.getElementById("subjectFilter");
  const val = subFilter.value;
  subFilter.innerHTML='<option value="">すべて</option>';
  subjects.forEach(s=>{
    const opt = document.createElement("option");
    opt.value=s; opt.textContent=s;
    subFilter.appendChild(opt);
  });
  subFilter.value = val;
}

function updateFilters(){
  const yearSet = new Set();
  const saved = JSON.parse(localStorage.getItem("kaikei"))||[];
  saved.forEach(d=>yearSet.add(new Date(d.date).getFullYear()));
  const yearSelect = document.getElementById("yearFilter");
  const subjectSelect = document.getElementById("subjectFilter");
  const valYear = yearSelect.value;
  const valSub = subjectSelect.value;
  yearSelect.innerHTML='<option value="">すべて</option>';
  yearSet.forEach(y=>{
    const opt = document.createElement("option"); opt.value=y; opt.textContent=y+'年度';
    yearSelect.appendChild(opt);
  });
  updateSubjectSelect();
  yearSelect.value = valYear;
  subjectSelect.value = valSub;
}

function render(){
  const tb = document.getElementById("list");
  tb.innerHTML="";
  const year = document.getElementById("yearFilter").value;
  const month = document.getElementById("monthFilter").value;
  const subjectF = document.getElementById("subjectFilter").value;

  let viewData = data.filter(d=>{
    const dt = new Date(d.date);
    if(year && dt.getFullYear()!=year) return false;
    if(month && dt.getMonth()+1!=month) return false;
    if(subjectF && d.subject!==subjectF) return false;
    return true;
  });
  viewData.sort((a,b)=>a.date.localeCompare(b.date));

  let cash=startCash, bank=startBank;
  viewData.forEach((d,i)=>{
    let ci="",co="",bi="",bo="";
    if(d.type==="収入"){ if(d.account==="現金"){ci=d.amount; cash+=d.amount} else{bi=d.amount; bank+=d.amount}}
    if(d.type==="支出"){ if(d.account==="現金"){co=d.amount; cash-=d.amount} else{bo=d.amount; bank-=d.amount}}
    if(d.type==="振替"){ if(d.account==="現金"){co=d.amount; bi=d.amount; cash-=d.amount; bank+=d.amount} else{bo=d.amount; ci=d.amount; bank-=d.amount; cash+=d.amount}}
    tb.innerHTML += `<tr>
      <td>${d.date}</td>
      <td onclick="edit(${i})">${d.subject}</td>
      <td>${d.content}</td>
      <td>${ci.toLocaleString()}</td><td>${co.toLocaleString()}</td><td>${cash.toLocaleString()}</td>
      <td>${bi.toLocaleString()}</td><td>${bo.toLocaleString()}</td><td>${bank.toLocaleString()}</td>
      <td>${d.note||""}</td>
      <td><button onclick="del(${i})">削除</button></td>
    </tr>`;
  });
  document.getElementById("cashBal").textContent=cash.toLocaleString();
  document.getElementById("bankBal").textContent=bank.toLocaleString();
}

// Excel出力（見やすく完全版）
function exportExcel(){
  const wb = XLSX.utils.book_new();
  const year = document.getElementById("yearFilter").value;
  const month = document.getElementById("monthFilter").value;
  const subjectF = document.getElementById("subjectFilter").value;

  let viewData = data.filter(d=>{
    const dt = new Date(d.date);
    if(year && dt.getFullYear()!=year) return false;
    if(month && dt.getMonth()+1!=month) return false;
    if(subjectF && d.subject!==subjectF) return false;
    return true;
  });

  function createCellStyle(bold=false, bgColor=null, align="center", numFormat=false){
    const s={ font:{ bold:bold }, alignment:{ horizontal:align } };
    if(bgColor) s.fill={ fgColor:{ rgb:bgColor } };
    if(numFormat) s.numFmt="#,##0";
    return s;
  }

  // 出納帳
  const sheet1 = [["日付","科目","内容","現金収入","現金支出","現金残高","通帳収入","通帳支出","通帳残高","備考"]];
  let cash = startCash, bank = startBank;
  viewData.forEach(d=>{
    let ci="",co="",bi="",bo="";
    if(d.type==="収入"){ if(d.account==="現金"){ci=d.amount; cash+=d.amount} else{bi=d.amount; bank+=d.amount}}
    if(d.type==="支出"){ if(d.account==="現金"){co=d.amount; cash-=d.amount} else{bo=d.amount; bank-=d.amount}}
    if(d.type==="振替"){ if(d.account==="現金"){co=d.amount; bi=d.amount; cash-=d.amount; bank+=d.amount} else{bo=d.amount; ci=d.amount; bank-=d.amount; cash+=d.amount}}
    sheet1.push([d.date,d.subject,d.content,ci,co,cash,bi,bo,bank,d.note]);
  });
  const ws1 = XLSX.utils.aoa_to_sheet(sheet1);
  // ヘッダ装飾
  for(let c=0;c<10;c++){
    const cell = ws1[XLSX.utils.encode_cell({c:c,r:0})];
    if(cell) cell.s = createCellStyle(true,"FFFFCC","center");
  }
  // 金額列右揃え＋カンマ
  [3,4,5,6,7,8].forEach(c=>{
    for(let r=1;r<sheet1.length;r++){
      const cell = ws1[XLSX.utils.encode_cell({c:c,r:r})];
      if(cell) cell.s = createCellStyle(false,null,"right",true);
    }
  });
  XLSX.utils.book_append_sheet(wb, ws1, "出納帳");

  // 収支決算書
  const income={}, expense={};
  viewData.forEach(d=>{
    if(d.type==="収入") income[d.subject]=(income[d.subject]||0)+d.amount;
    if(d.type==="支出") expense[d.subject]=(expense[d.subject]||0)+d.amount;
  });
  const sheet2=[["令和〇年度 収支決算報告書"],[],["収入","","支出"],[]];
  const keys = [...new Set([...Object.keys(income),...Object.keys(expense)])];
  let tin=0,tout=0;
  keys.forEach(k=>{
    const i=income[k]||""; const o=expense[k]||""; if(i) tin+=i; if(o) tout+=o;
    sheet2.push([k,i,k,o]);
  });
  sheet2.push(["合計",tin,"合計",tout]);
  const ws2 = XLSX.utils.aoa_to_sheet(sheet2);
  // ヘッダ装飾
  for(let c=0;c<4;c++){
    const cell = ws2[XLSX.utils.encode_cell({c:c,r:2})]; if(cell) cell.s = createCellStyle(true,"FFFFCC","center");
  }
  // 合計行装飾
  const lastRow = sheet2.length-1;
  for(let c=0;c<4;c++){
    const cell = ws2[XLSX.utils.encode_cell({c:c,r:lastRow})]; if(cell) cell.s = createCellStyle(true,"DDDDDD","right",true);
  }
  XLSX.utils.book_append_sheet(wb, ws2, "収支決算書");

  // 科目別
  const subjectsMap={};
  viewData.forEach(d=>{ if(!subjectsMap[d.subject]) subjectsMap[d.subject]=[]; subjectsMap[d.subject].push(d); });
  Object.keys(subjectsMap).forEach(s=>{
    const sh=[["日付","内容","金額","備考"]];
    let sum=0;
    subjectsMap[s].forEach(d=>{sum+=d.amount; sh.push([d.date,d.content,d.amount,d.note])});
    sh.push(["小計","",sum,""]);
    const ws = XLSX.utils.aoa_to_sheet(sh);
    // ヘッダ装飾
    for(let c=0;c<4;c++){
      const cellH = ws[XLSX.utils.encode_cell({c:c,r:0})]; if(cellH) cellH.s = createCellStyle(true,"FFFFCC","center");
      const lastR = sh.length-1;
      const cellF = ws[XLSX.utils.encode_cell({c:c,r:lastR})]; if(cellF) cellF.s = createCellStyle(true,"DDDDDD","right",true);
    }
    // 金額列右揃え＋カンマ
    for(let r=1;r<sh.length-1;r++){
      const cell = ws[XLSX.utils.encode_cell({c:2,r:r})]; if(cell) cell.s = createCellStyle(false,null,"right",true);
    }
    XLSX.utils.book_append_sheet(wb, ws, s);
  });

  XLSX.writeFile(wb,"会計.xlsx");
}

window.onload = ()=>{
  if(localStorage.getItem("startCash")!==null) document.getElementById("carryArea").style.display="none";
  updateSubjectSelect();
  render();
}
</script>
</body>
</html>

