<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <title>学生団体 会計ソフト</title>

    <!-- Excel出力のJSライブラリの読み込み -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="./main.js"></script>

    <!-- CSSの読み込み -->
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="filter-panel">
      <h2>表示フィルタ</h2>
      <label for="yearFilter">年度: </label>
      <select id="yearFilter">
        <option value="">すべて</option>
      </select>

      <label for="monthFilter">月: </label>
      <select id="monthFilter">
        <option value="">すべて</option>
        <option value="1">1月</option>
        <option value="2">2月</option>
        <option value="3">3月</option>
        <option value="4">4月</option>
        <option value="5">5月</option>
        <option value="6">6月</option>
        <option value="7">7月</option>
        <option value="8">8月</option>
        <option value="9">9月</option>
        <option value="10">10月</option>
        <option value="11">11月</option>
        <option value="12">12月</option>
      </select>

      <label for="subjectFilter">科目: </label>
      <select id="subjectFilter">
        <option value="">すべて</option>
      </select>

      <!-- 高度フィルタ: キーワード/金額範囲 -->
      <label for="kwFilter">キーワード: </label>
      <input type="text" id="kwFilter" placeholder="内容/備考検索" />

      <label for="amountMin">金額: </label>
      <input type="number" id="amountMin" placeholder="最小" style="width:90px;" />
      <span>〜</span>
      <input type="number" id="amountMax" placeholder="最大" style="width:90px;" />

      <button onclick="render()">再表示</button>
      <button id="bulkEditBtn" onclick="toggleBulkEditMode()">総編集モード</button>
    </div>

    <!-- 総編集モード: 一括操作と一括変更パネル -->
    <div id="bulkActions" style="display:none; margin-bottom:10px; padding:10px; background:#ffe; border:1px solid #dda;">
      <div style="margin-bottom:6px;">
        <button onclick="deleteSelected()">選択した項目を削除</button>
        <button onclick="selectAllRows()">全選択</button>
        <button onclick="deselectAllRows()">選択解除</button>
      </div>
      <!-- 一括変更パネル：区分/口座(振替は方向)/金額の上書き -->
      <div id="bulkChangePanel">
        <strong>一括変更:</strong>
        <label>区分:</label>
        <select id="bulkType" onchange="bulkTypeChanged()">
          <option value="">(変更しない)</option>
          <option value="収入">収入</option>
          <option value="支出">支出</option>
          <option value="振替">振替</option>
        </select>
        <span id="bulkAccountWrap">
          <label>口座:</label>
          <select id="bulkAccount">
            <option value="">(変更しない)</option>
            <option value="現金">現金</option>
            <option value="通帳">通帳</option>
          </select>
        </span>
        <span id="bulkTransferWrap" style="display:none;">
          <label>振替方向:</label>
          <select id="bulkTransferDir">
            <option value="deposit">預入 (現金→通帳)</option>
            <option value="withdraw">引出 (通帳→現金)</option>
          </select>
        </span>
        <label>金額(上書き):</label>
        <input type="number" id="bulkAmount" style="width:120px;" placeholder="空欄は変更なし" />
        <button onclick="applyBulkChanges()">選択に一括適用</button>
      </div>
    </div>

    <div id="kaikei-panel">
      <h1>会計入力</h1>

      <!-- 繰越金の入力フォーム -->
      <div id="carryArea">
        <h3>繰越金 (初回のみ入力)</h3>
        <label for="startCash">現金</label>
        <input type="number" id="startCash" value="0" />
        
        <label for="startBank">通帳</label>
        <input type="number" id="startBank" value="0" />
        
        <button onclick="setStart()">設定</button>
      </div>

      <hr>

      <!-- 入力フォーム -->
      <div id="entry">
        <label for="date">日付: </label>
        <input type="date" id="date" />

        <label for="subject">科目: </label>
        <select id="subject"></select>
        <button onclick="addSubject()">科目を作成する</button>

        <label for="content">内容: </label>
        <input type="text" id="content" placeholder="内容" />

        <div class="inline-field">
          <span class="label">区分: </span>
          <label class="radio"><input type="radio" name="type" value="収入" checked>収入</label>
          <label class="radio"><input type="radio" name="type" value="支出">支出</label>
          <label class="radio"><input type="radio" name="type" value="振替">振替</label>
        </div>

        <div id="accountGroup" class="inline-field">
          <span class="label">口座: </span>
          <label class="radio"><input type="radio" name="account" value="現金" checked>現金</label>
          <label class="radio"><input type="radio" name="account" value="通帳">通帳</label>
        </div>

        <div id="transferGroup" class="inline-field" style="display:none;">
          <span class="label">振替方向: </span>
          <label class="radio"><input type="radio" name="transferDirection" value="deposit" checked>預入 (現金→通帳)</label>
          <label class="radio"><input type="radio" name="transferDirection" value="withdraw">引出 (通帳→現金)</label>
        </div>

        <label for="amount">金額: </label>
        <input type="number" id="amount" placeholder="1000 (金額)" />

        <label for="note">備考: </label>
        <input type="text" id="note" placeholder="備考" />

        <button id="saveBtn" onclick="save()">追加</button>
        <button id="cancelEditBtn" style="display:none;" onclick="cancelEdit()">キャンセル</button>
        <span id="editIndicator" class="edit-indicator" style="display:none;">編集中</span>
      </div>
    </div>

    <!-- 残高表示 -->
    <div id="balance-panel">
      <h2>残高</h2>
      現金: <span id="cashBal">0</span> / 通帳: <span id="bankBal">0</span>
    </div>

    <div id="cashbook-panel">
      <h2>出納帳</h2>
      <table>
        <thead>
          <tr>
          <th>日付</th>
          <th>科目</th>
          <th>内容</th>
          <th>現金収入</th>
          <th>現金支出</th>
          <th>現金残高</th>
          <th>通帳収入</th>
          <th>通帳支出</th>
          <th>通帳残高</th>
          <th>備考</th>
          <th>操作</th>
          </tr>
        </thead>
        <tbody id="list"></tbody>
      </table>
    </div>

    <br>
    
    <button onclick="exportExcel()">Excel出力</button>
    <button onclick="exportBackup()">バックアップDL</button>
    <label for="importBackupInput" style="margin-left:6px;">復元:</label>
    <input type="file" id="importBackupInput" accept="application/json" onchange="importBackup(event)" />

    <script>
      // 初期化
      main();
    </script>
  </body>
</html>